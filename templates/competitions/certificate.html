{% extends 'base.html' %}

{% block title %}Sertifikat - {{ competition.name }} - Typing Trainer{% endblock %}

{% block extra_css %}
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        .certificate-container, .certificate-container * {
            visibility: visible;
        }
        .certificate-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .no-print {
            display: none;
        }
    }
    /* Pixel-ish, minimal, dark on light */
    .certificate {
        background: #f7f7f0;
        border: 6px solid #111;
        border-radius: 10px;
        /* A4 dimensions */
        width: 210mm;
        min-height: 297mm;
        box-sizing: border-box;
        padding: 26mm;
        margin: 0 auto;
        box-shadow:
            8px 8px 0 #111,
            16px 16px 0 #00000040;
    }
    .certificate-header {
        text-align: center;
        margin-bottom: 32px;
    }
    .certificate-logo {
        max-width: 120px;
        max-height: 120px;
        margin: 0 auto 16px;
        image-rendering: pixelated;
    }
    .certificate-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #111;
        letter-spacing: 0.04em;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    .certificate-subtitle {
        font-size: 1.1rem;
        color: #3b3b3b;
        margin-bottom: 12px;
    }
    .pixel-bar {
        height: 10px;
        background: repeating-linear-gradient(
            90deg,
            #111 0 16px,
            #faf9cf 16px 32px
        );
        margin: 16px 0 24px;
    }
    .certificate-body {
        text-align: center;
        margin: 28px 0;
    }
    .certificate-name {
        font-size: 2.2rem;
        font-weight: 800;
        color: #111;
        padding: 16px;
        display: inline-block;
        border: 4px solid #111;
        box-shadow: 6px 6px 0 #111;
        margin: 16px 0 20px;
    }
    .certificate-text {
        font-size: 1.1rem;
        color: #1f1f1f;
        line-height: 1.6;
        margin: 12px 0;
    }
    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        width: 96px;
        height: 96px;
        border: 4px solid #111;
        border-radius: 14px;
        box-shadow: 6px 6px 0 #111;
        margin: 12px 0 16px;
        background: #faf9cf;
        color: #111;
    }
    .certificate-details {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 14px;
    }
    .certificate-detail-item {
        border: 2px solid #111;
        border-radius: 10px;
        padding: 12px;
        box-shadow: 4px 4px 0 #111;
        background: #fffef7;
    }
    .certificate-detail-label {
        font-size: 0.85rem;
        color: #3b3b3b;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .certificate-detail-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #111;
    }
    .certificate-footer {
        margin-top: 30px;
        text-align: center;
        padding-top: 18px;
        border-top: 3px solid #111;
    }
    .certificate-signatures {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }
    .certificate-signature {
        text-align: center;
        padding-top: 32px;
        position: relative;
        min-height: 80px;
    }
    .signature-line {
        border-top: 2px solid #111;
        padding-top: 8px;
        font-size: 0.9rem;
        color: #1f1f1f;
    }
    .additional-names {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
    }
    .pill {
        padding: 6px 10px;
        border: 2px solid #111;
        border-radius: 8px;
        background: #fffef7;
        box-shadow: 3px 3px 0 #111;
        font-weight: 600;
        color: #111;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8">
    <div class="no-print mb-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <a href="{% url 'competitions:results' competition.id %}" class="inline-flex items-center space-x-2 text-primary hover:text-primary-dark font-semibold transition-colors duration-300 hover:underline">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    <span>Natijalarga qaytish</span>
                </a>
                <div class="flex items-center space-x-3">
                    <button onclick="downloadAsPDF()" class="inline-flex items-center space-x-2 gradient-secondary text-primary px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>PDF yuklab olish</span>
                    </button>
                    <button onclick="window.print()" class="inline-flex items-center space-x-2 gradient-secondary text-primary px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                        </svg>
                        <span>Chop etish</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="certificate-container">
        <div class="certificate">
            <div class="certificate-header">
                {% if certificate.logo %}
                <img src="{{ certificate.logo.url }}" alt="Logo" class="certificate-logo">
                {% endif %}
                <h1 class="certificate-title">{{ certificate.organization_name|default:"GEEKS ANDIJAN" }}</h1>
                <p class="certificate-subtitle">{{ certificate.certificate_subtitle|default:"Typing Competition Certificate" }}</p>
            </div>

            <div class="certificate-body">
                <p class="certificate-text">Certified Achievement</p>
                
                <div class="rank-badge">
                    {% if rank == 1 %}ðŸ¥‡{% elif rank == 2 %}ðŸ¥ˆ{% elif rank == 3 %}ðŸ¥‰{% endif %}
                </div>
                
                <div class="certificate-name">{{ winner.user.get_full_name|default:winner.user.username }}</div>
                
                <p class="certificate-text">
                    {{ competition.name }} musobaqasida {% if rank == 1 %}1{% elif rank == 2 %}2{% else %}3{% endif %}-o'rin.
                </p>

                <div class="certificate-details">
                    <div class="certificate-detail-item">
                        <div class="certificate-detail-label">O'rtacha WPM</div>
                        <div class="certificate-detail-value">{{ winner.result_wpm|floatformat:1 }}</div>
                    </div>
                    <div class="certificate-detail-item">
                        <div class="certificate-detail-label">O'rtacha Aniqlik</div>
                        <div class="certificate-detail-value">{{ winner.accuracy|floatformat:1 }}%</div>
                    </div>
                    <div class="certificate-detail-item">
                        <div class="certificate-detail-label">Musobaqa sanasi</div>
                        <div class="certificate-detail-value">{{ competition.start_time|date:"d.m.Y" }}</div>
                    </div>
                </div>
            </div>

            <div class="certificate-footer">
                {% if certificate.get_additional_names_list %}
                <div class="additional-names">
                    {% for name in certificate.get_additional_names_list %}
                    <span class="pill">{{ name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="certificate-signatures">
                    <div class="certificate-signature">
                        <div class="signature-line">
                            {{ certificate.signature_name|default:"Geeks Andijan" }}
                        </div>
                    </div>
                    <div class="certificate-signature">
                        <div class="signature-line">
                            Sana: {{ competition.finished_at|date:"d.m.Y"|default:competition.start_time|date:"d.m.Y" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function downloadAsPDF() {
    const element = document.querySelector('.certificate-container');
    const opt = {
        margin: 0,
        filename: '{{ competition.name|slugify }}_{{ winner.user.username }}_sertifikat.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    html2pdf().set(opt).from(element).save();
}
</script>
{% endblock %}

