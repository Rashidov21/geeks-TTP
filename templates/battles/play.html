{% extends 'base.html' %}

{% block title %}Jang - {{ battle }} - Typing Trainer{% endblock %}

{% block extra_css %}
{% if battle.mode == 'code' %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    .word { margin-right: 0.5rem; }
    .correct { color: #292929; }
    .incorrect { background-color: #fee2e2; color: #dc2626; }
    .current { background-color: rgba(41, 41, 41, 0.1); border-left: 3px solid #292929; padding-left: 2px; }
    .typed { color: #6b7280; }
    .stats-card {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        color: #292929;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    .stats-card.wpm { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); }
    .stats-card.accuracy { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); }
    .stats-card.time { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); }
    .stats-card.mistakes { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); }
    #code-display {
        font-family: 'Fira Code', 'Courier New', monospace;
        font-size: 15px;
        line-height: 1.6;
    }
    .code-line {
        padding: 2px 0;
        min-height: 1.6em;
    }
    .code-line.hljs {
        background: transparent !important;
    }
    .opponent-info {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .stats-card.wpm { 
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #3b82f6;
    }
    .stats-card.accuracy { 
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border: 2px solid #22c55e;
    }
    .stats-card.time { 
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
    }
    .stats-card.mistakes { 
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 2px solid #ef4444;
    }
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
    .winner-badge {
        animation: bounce 1s infinite;
    }
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    .progress-bar-animated {
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Countdown Modal -->
    <div id="countdown-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="text-center">
            <div id="countdown-number" class="text-9xl font-bold text-white mb-4">3</div>
            <p class="text-2xl text-white">Jang boshlanmoqda...</p>
        </div>
    </div>

    <!-- Battle Info -->
    <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-primary">{{ battle.creator.username }} vs {{ battle.opponent.username }}</h1>
                <div class="flex items-center space-x-3 mt-1">
                    <span class="text-sm text-primary">
                        {% if battle.mode == 'text' %}üìù Matn{% else %}üíª Kod{% endif %}
                    </span>
                    <span class="text-sm text-gray-600">
                        {% if battle.battle_type == 'speed' %}‚ö° Tezlik
                        {% elif battle.battle_type == 'accuracy' %}üéØ Aniqlik
                        {% elif battle.battle_type == 'endurance' %}üí™ Chidamlilik
                        {% else %}‚öñÔ∏è Muvozanatli{% endif %}
                    </span>
                </div>
            </div>
            <div id="opponent-status" class="opponent-info">
                <p class="text-sm font-semibold text-primary">Raqib holati:</p>
                <p class="text-lg font-bold text-primary" id="opponent-finished">Kutmoqda...</p>
                <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="opponent-progress" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1" id="opponent-progress-text">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Comparison -->
    <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
        <h3 class="text-sm font-semibold text-primary mb-2">Jarayon taqqoslash</h3>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <p class="text-xs text-gray-600 mb-1">Siz</p>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="my-progress" class="bg-green-500 h-3 rounded-full progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
            <div>
                <p class="text-xs text-gray-600 mb-1">Raqib</p>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="opponent-progress-bar" class="bg-blue-500 h-3 rounded-full progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Live WPM Display -->
        <div class="mt-4">
            <h4 class="text-xs font-semibold text-primary mb-2 flex items-center space-x-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                <span>WPM rivojlanishi</span>
            </h4>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-blue-50 rounded-lg p-3 border-2 border-blue-200">
                    <div class="flex items-center space-x-2 mb-1">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-xs font-medium text-blue-600">Sizning WPM</span>
                    </div>
                    <p class="text-xl font-bold text-blue-600" id="current-wpm-display">0</p>
                </div>
                <div class="bg-red-50 rounded-lg p-3 border-2 border-red-200">
                    <div class="flex items-center space-x-2 mb-1">
                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-xs font-medium text-red-600">Raqib WPM</span>
                    </div>
                    <p class="text-xl font-bold text-red-600" id="opponent-wpm-display">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <div class="stats-card wpm">
            <p class="text-sm font-medium text-primary opacity-90 mb-1">{% if battle.mode == 'text' %}WPM{% else %}Code WPM{% endif %}</p>
            <p class="text-3xl font-bold text-primary" id="wpm">0</p>
        </div>
        <div class="stats-card accuracy">
            <p class="text-sm font-medium text-primary opacity-90 mb-1">Aniqlik</p>
            <p class="text-3xl font-bold text-primary" id="accuracy">100%</p>
        </div>
        <div class="stats-card time">
            <p class="text-sm font-medium text-primary opacity-90 mb-1">Vaqt</p>
            <p class="text-3xl font-bold text-primary" id="timer">0s</p>
            <div class="w-full bg-gray-200 rounded-full h-1 mt-2">
                <div id="time-progress" class="bg-red-500 h-1 rounded-full transition-all duration-100" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1" id="time-limit-text">Limit: {{ battle.time_limit_seconds }}s</p>
        </div>
        <div class="stats-card mistakes">
            <p class="text-sm font-medium text-primary opacity-90 mb-1">Xatolar</p>
            <p class="text-3xl font-bold text-primary" id="mistakes-count">0</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        {% if battle.mode == 'text' %}
        <!-- Text Battle -->
        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2 text-primary">{{ battle.text.title }}</h3>
            <div id="text-display" class="text-2xl leading-relaxed p-8 bg-gray-50 rounded-lg border-2 border-gray-200 mb-6 font-mono text-primary">
            </div>
        </div>
        {% else %}
        <!-- Code Battle -->
        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2 text-primary">{{ battle.code_snippet.title }}</h3>
            <div id="code-display" class="p-6 bg-gray-50 text-primary rounded-lg border-2 border-gray-300 mb-6 overflow-auto">
                <pre><code class="language-{{ battle.code_snippet.language }}">{{ battle.code_snippet.code_body }}</code></pre>
            </div>
        </div>
        {% endif %}
        
        <textarea 
            id="typing-input" 
            class="w-full p-6 bg-gray-50 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary text-xl font-mono text-primary placeholder-gray-400 transition-all duration-300"
            rows="{% if battle.mode == 'text' %}5{% else %}12{% endif %}"
            placeholder="Bu yerga yozishni boshlang..."
            autofocus
            spellcheck="false"
        ></textarea>
        
        <div class="mt-4 flex justify-center">
            <button id="finish-btn" class="flex items-center space-x-2 gradient-secondary text-primary px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Tugatish</span>
            </button>
        </div>
    </div>
    
    <!-- Results -->
    <div id="results" class="hidden mt-6 bg-white rounded-lg shadow-lg p-6 animate-fadeIn">
        <div id="winner-badge" class="hidden text-center mb-4">
            <div class="inline-block bg-gradient-to-r from-yellow-400 to-yellow-600 text-white px-8 py-4 rounded-lg shadow-lg winner-badge">
                <h2 class="text-3xl font-bold">üèÜ G'OLIB! üèÜ</h2>
                <p class="text-lg mt-2">Tabriklaymiz! Siz yutdingiz!</p>
            </div>
        </div>
        <div id="loser-badge" class="hidden text-center mb-4">
            <div class="inline-block bg-gray-500 text-white px-8 py-4 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold">Jang tugadi</h2>
                <p class="text-sm mt-2">Yaxshi urinish! Keyingi safar omad!</p>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-primary mb-4">Sizning natijangiz</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                <p class="text-sm font-semibold text-primary mb-1">{% if battle.mode == 'text' %}WPM{% else %}Code WPM{% endif %}</p>
                <p class="text-3xl font-bold text-primary" id="result-wpm">0</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                <p class="text-sm font-semibold text-primary mb-1">Aniqlik</p>
                <p class="text-3xl font-bold text-primary" id="result-accuracy">0%</p>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg border-2 border-red-200">
                <p class="text-sm font-semibold text-red-700 mb-1">Xatolar</p>
                <p class="text-3xl font-bold text-red-600" id="result-mistakes">0</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                <p class="text-sm font-semibold text-primary mb-1">Vaqt</p>
                <p class="text-3xl font-bold text-primary" id="result-time">0s</p>
            </div>
        </div>
        <div class="text-center">
            <a href="{% url 'battles:detail' battle.id %}" class="inline-flex items-center space-x-2 gradient-secondary text-primary px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                </svg>
                <span>Jang natijalarini ko'rish</span>
            </a>
        </div>
    </div>
</div>

<script>
{% if battle.mode == 'text' %}
const originalText = `{{ battle.text.body|escapejs }}`;
{% else %}
const originalCode = `{{ battle.code_snippet.code_body|escapejs }}`;
const codeLanguage = '{{ battle.code_snippet.language }}';
{% endif %}
const battleId = {{ battle.id }};
const timeLimit = {{ battle.time_limit_seconds }};
const countdownSeconds = {{ battle.countdown_seconds }};
let startTime = null;
let timerInterval = null;
let isFinished = false;
let mistakesList = [];
let opponentCheckInterval = null;
let countdownInterval = null;
let updateProgressInterval = null;
let myProgress = 0;
let wpmHistory = [];

const typingInput = document.getElementById('typing-input');
const finishBtn = document.getElementById('finish-btn');
const resultsDiv = document.getElementById('results');
{% if battle.mode == 'text' %}
const textDisplay = document.getElementById('text-display');
{% else %}
const codeDisplay = document.getElementById('code-display');
{% endif %}

let lastTypedLength = 0;

{% if battle.mode == 'text' %}
function initTextDisplay() {
    const words = originalText.trim().split(/\s+/);
    textDisplay.innerHTML = words.map((word, i) => 
        `<span class="word" data-index="${i}">${word}</span>`
    ).join(' ');
    lastTypedLength = 0;
}
{% else %}
function initCodeDisplay() {
    if (typeof hljs !== 'undefined') {
        hljs.highlightAll();
    }
    lastTypedLength = 0;
}
{% endif %}

// Prevent copy-paste
typingInput.addEventListener('paste', (e) => {
    e.preventDefault();
    return false;
});

typingInput.addEventListener('copy', (e) => {
    e.preventDefault();
    return false;
});

typingInput.addEventListener('cut', (e) => {
    e.preventDefault();
    return false;
});

// Check opponent status periodically
function checkOpponentStatus() {
    fetch(`{% url 'battles:detail' battle.id %}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.text())
    .then(html => {
        // Parse opponent status from response (simplified - in production use API)
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        // This is a simplified check - you might want to create a dedicated API endpoint
    })
    .catch(err => console.error('Error checking opponent:', err));
}

// Start checking opponent status
opponentCheckInterval = setInterval(checkOpponentStatus, 3000); // Check every 3 seconds

typingInput.addEventListener('input', (e) => {
    const currentValue = typingInput.value;
    const currentLength = currentValue.length;
    const previousLength = lastTypedLength;
    
    // Detect paste
    if (currentLength - previousLength > 1) {
        typingInput.value = currentValue.substring(0, previousLength);
        return;
    }
    
    lastTypedLength = typingInput.value.length;
    startTyping();
    updateDisplay();
});

{% if battle.mode == 'text' %}
function updateDisplay() {
    const typed = typingInput.value;
    const words = originalText.trim().split(/\s+/);
    const typedWords = typed.trim().split(/\s+/);
    
    let html = '';
    let mistakes = 0;
    mistakesList = [];
    
    words.forEach((word, i) => {
        const typedWord = typedWords[i] || '';
        let classes = 'word';
        
        if (i < typedWords.length - 1) {
            if (word === typedWord) {
                classes += ' correct typed';
            } else {
                classes += ' incorrect typed';
                mistakes++;
            }
        } else if (i === typedWords.length - 1) {
            classes += ' current';
            if (typedWord.length > 0 && !word.startsWith(typedWord)) {
                classes += ' incorrect';
                mistakes++;
            }
        }
        
        html += `<span class="${classes}" data-index="${i}">${word}</span> `;
    });
    
    textDisplay.innerHTML = html;
    
        if (startTime) {
        const elapsed = (Date.now() - startTime) / 1000;
        const typedChars = typed.length;
        const correctChars = typedChars - mistakes;
        const wpm = (typedWords.length / elapsed) * 60;
        const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
        
        // Calculate progress
        const totalWords = words.length;
        const typedWordsCount = typedWords.length;
        myProgress = Math.min(100, (typedWordsCount / totalWords) * 100);
        
        document.getElementById('wpm').textContent = Math.round(wpm);
        document.getElementById('accuracy').textContent = Math.round(accuracy) + '%';
        document.getElementById('timer').textContent = Math.round(elapsed) + 's';
        document.getElementById('mistakes-count').textContent = mistakes;
        
        // Update progress bars
        document.getElementById('my-progress').style.width = myProgress + '%';
        
        // Update WPM display
        document.getElementById('current-wpm-display').textContent = Math.round(wpm);
        
        // Update time limit progress
        const timeProgress = Math.min(100, (elapsed / timeLimit) * 100);
        document.getElementById('time-progress').style.width = timeProgress + '%';
        
        // Color coding for time
        const timeProgressEl = document.getElementById('time-progress');
        if (timeProgress > 80) {
            timeProgressEl.className = 'bg-red-500 h-1 rounded-full transition-all duration-100 pulse-animation';
        } else if (timeProgress > 60) {
            timeProgressEl.className = 'bg-yellow-500 h-1 rounded-full transition-all duration-100';
        } else {
            timeProgressEl.className = 'bg-green-500 h-1 rounded-full transition-all duration-100';
        }
        
        if (timeProgress >= 100) {
            // Time limit reached
            finishTyping(wpm, accuracy, mistakes, elapsed);
        }
        
        if (typedWords.length >= words.length && typed.trim().length >= originalText.trim().length) {
            finishTyping(wpm, accuracy, mistakes, elapsed);
        }
    }
}
{% else %}
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateDisplay() {
    const typed = typingInput.value;
    const originalLines = originalCode.split('\n');
    const typedLines = typed.split('\n');
    
    let html = '';
    let mistakes = 0;
    mistakesList = [];
    
    originalLines.forEach((line, lineIdx) => {
        const typedLine = typedLines[lineIdx] || '';
        let lineHtml = '<div class="code-line">';
        
        if (lineIdx < typedLines.length - 1) {
            if (line === typedLine) {
                lineHtml += '<span class="correct typed">' + escapeHtml(line) + '</span>';
            } else {
                lineHtml += '<span class="incorrect typed">' + escapeHtml(line) + '</span>';
                mistakes++;
                mistakesList.push({ line: lineIdx + 1, original: line, typed: typedLine });
            }
        } else if (lineIdx === typedLines.length - 1) {
            for (let i = 0; i < line.length; i++) {
                const typedChar = typedLine[i] || '';
                const originalChar = line[i];
                
                if (i < typedLine.length) {
                    if (originalChar === typedChar) {
                        lineHtml += '<span class="correct typed">' + escapeHtml(originalChar) + '</span>';
                    } else {
                        lineHtml += '<span class="incorrect">' + escapeHtml(originalChar) + '</span>';
                        mistakes++;
                    }
                } else if (i === typedLine.length) {
                    lineHtml += '<span class="current">' + escapeHtml(originalChar) + '</span>';
                } else {
                    lineHtml += '<span>' + escapeHtml(originalChar) + '</span>';
                }
            }
        } else {
            if (typeof hljs !== 'undefined') {
                const highlighted = hljs.highlight(line, { language: codeLanguage });
                lineHtml += highlighted.value;
            } else {
                lineHtml += escapeHtml(line);
            }
        }
        
        lineHtml += '</div>';
        html += lineHtml;
    });
    
    codeDisplay.querySelector('pre code').innerHTML = html;
    if (typeof hljs !== 'undefined') {
        hljs.highlightAll();
    }
    
    if (startTime) {
        const elapsed = (Date.now() - startTime) / 1000;
        const typedChars = typed.length;
        const correctChars = typedChars - mistakes;
        const wpm = (typedChars / 5 / elapsed) * 60;
        const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
        
        // Calculate progress for code
        const totalChars = originalCode.length;
        myProgress = Math.min(100, (typedChars / totalChars) * 100);
        
        document.getElementById('wpm').textContent = Math.round(wpm);
        document.getElementById('accuracy').textContent = Math.round(accuracy) + '%';
        document.getElementById('timer').textContent = Math.round(elapsed) + 's';
        document.getElementById('mistakes-count').textContent = mistakes;
        
        // Update progress bars
        document.getElementById('my-progress').style.width = myProgress + '%';
        
        // Update WPM display
        document.getElementById('current-wpm-display').textContent = Math.round(wpm);
        
        // Update time limit progress
        const timeProgress = Math.min(100, (elapsed / timeLimit) * 100);
        document.getElementById('time-progress').style.width = timeProgress + '%';
        
        // Color coding for time
        const timeProgressEl = document.getElementById('time-progress');
        if (timeProgress > 80) {
            timeProgressEl.className = 'bg-red-500 h-1 rounded-full transition-all duration-100 pulse-animation';
        } else if (timeProgress > 60) {
            timeProgressEl.className = 'bg-yellow-500 h-1 rounded-full transition-all duration-100';
        } else {
            timeProgressEl.className = 'bg-green-500 h-1 rounded-full transition-all duration-100';
        }
        
        if (timeProgress >= 100) {
            // Time limit reached
            finishTyping(wpm, accuracy, mistakes, elapsed);
        }
        
        if (typed.trim() === originalCode.trim()) {
            finishTyping(wpm, accuracy, mistakes, elapsed);
        }
    }
}
{% endif %}

// Countdown before starting
function startCountdown() {
    let count = countdownSeconds;
    const countdownModal = document.getElementById('countdown-modal');
    const countdownNumber = document.getElementById('countdown-number');
    
    countdownModal.classList.remove('hidden');
    countdownNumber.textContent = count;
    
    countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownNumber.textContent = count;
        } else {
            countdownNumber.textContent = 'GO!';
            clearInterval(countdownInterval);
            setTimeout(() => {
                countdownModal.classList.add('hidden');
                typingInput.disabled = false;
                typingInput.focus();
                startTyping();
            }, 500);
        }
    }, 1000);
}

// Update progress to server periodically
function updateProgressToServer() {
    if (!startTime || isFinished) return;
    
    const elapsed = (Date.now() - startTime) / 1000;
    {% if battle.mode == 'text' %}
    const typedWords = typed.trim().split(/\s+/).filter(w => w);
    const totalWords = originalText.trim().split(/\s+/).length;
    const typedWordsCount = typedWords.length;
    const typedChars = typed.length;
    const correctChars = typedChars - mistakes;
    const wpm = (typedWords.length / elapsed) * 60;
    const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
    const progress = Math.min(100, (typedWordsCount / totalWords) * 100);
    {% else %}
    const typedChars = typed.length;
    const correctChars = typedChars - mistakes;
    const totalChars = originalCode.length;
    const wpm = (typedChars / 5 / elapsed) * 60;
    const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
    const progress = Math.min(100, (typedChars / totalChars) * 100);
    {% endif %}
    
    // Send progress update to server
    fetch('{% url "battles:update_progress" battle.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            wpm: wpm,
            accuracy: accuracy,
            mistakes: mistakes,
            progress: progress,
        })
    })
    .catch(err => console.error('Error updating progress:', err));
}

function startTyping() {
    if (!startTime) {
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 100);
        finishBtn.disabled = false;
        
        // Start checking opponent progress
        checkOpponentProgress();
        opponentCheckInterval = setInterval(checkOpponentProgress, 2000);
        
        // Start updating progress to server every 3 seconds
        updateProgressInterval = setInterval(updateProgressToServer, 3000);
    }
}

// Check opponent progress
function checkOpponentProgress() {
    fetch(`{% url 'battles:opponent_progress' battle.id %}`)
        .then(response => response.json())
        .then(data => {
            if (data.progress !== undefined) {
                document.getElementById('opponent-progress').style.width = data.progress + '%';
                document.getElementById('opponent-progress-text').textContent = Math.round(data.progress) + '%';
                document.getElementById('opponent-progress-bar').style.width = data.progress + '%';
                
                // Update opponent WPM display
                if (data.wpm !== null && data.wpm !== undefined) {
                    document.getElementById('opponent-wpm-display').textContent = Math.round(data.wpm);
                }
                
                if (data.is_finished) {
                    document.getElementById('opponent-finished').textContent = 'Tugatdi!';
                    if (data.wpm) {
                        document.getElementById('opponent-finished').textContent = `Tugatdi! (${Math.round(data.wpm)} WPM)`;
                    }
                }
            }
        })
        .catch(err => console.error('Error checking opponent:', err));
}

function finishTyping(wpm, accuracy, mistakes, duration) {
    if (isFinished) return;
    isFinished = true;
    
    clearInterval(timerInterval);
    if (opponentCheckInterval) {
        clearInterval(opponentCheckInterval);
    }
    if (updateProgressInterval) {
        clearInterval(updateProgressInterval);
    }
    typingInput.disabled = true;
    finishBtn.disabled = true;
    
    document.getElementById('result-wpm').textContent = Math.round(wpm);
    document.getElementById('result-accuracy').textContent = Math.round(accuracy) + '%';
    document.getElementById('result-mistakes').textContent = mistakes;
    document.getElementById('result-time').textContent = Math.round(duration) + 's';
    resultsDiv.classList.remove('hidden');
    
    // Save result to battle
    fetch('{% url "battles:save_result" battle.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            wpm: wpm,
            accuracy: accuracy,
            mistakes: mistakes,
            progress: myProgress,
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Check if battle is finished
            if (data.battle_finished) {
                document.getElementById('opponent-finished').textContent = 'Jang tugadi!';
                
                // Show winner/loser badge
                if (data.winner && data.winner === '{{ request.user.username }}') {
                    document.getElementById('winner-badge').classList.remove('hidden');
                    // Confetti animation for winner
                    if (window.confetti) {
                        confetti({
                            particleCount: 200,
                            spread: 100,
                            origin: { y: 0.6 },
                            colors: ['#FFD700', '#FFA500', '#FF6347', '#32CD32', '#1E90FF']
                        });
                        // Multiple bursts
                        setTimeout(() => confetti({ particleCount: 100, angle: 60, spread: 55, origin: { x: 0 } }), 300);
                        setTimeout(() => confetti({ particleCount: 100, angle: 120, spread: 55, origin: { x: 1 } }), 600);
                    }
                } else {
                    document.getElementById('loser-badge').classList.remove('hidden');
                }
            } else {
                document.getElementById('opponent-finished').textContent = 'Raqib tugatishni kutmoqda...';
            }
        }
    })
    .catch(err => console.error('Error saving result:', err));
}

finishBtn.addEventListener('click', () => {
    const typed = typingInput.value;
    const elapsed = (Date.now() - startTime) / 1000;
    {% if battle.mode == 'text' %}
    const words = originalText.trim().split(/\s+/);
    const typedWords = typed.trim().split(/\s+/);
    const typedChars = typed.length;
    const mistakes = mistakesList.length;
    const correctChars = typedChars - mistakes;
    const wpm = (typedWords.length / elapsed) * 60;
    const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
    {% else %}
    const typedChars = typed.length;
    const mistakes = mistakesList.length;
    const correctChars = typedChars - mistakes;
    const wpm = (typedChars / 5 / elapsed) * 60;
    const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
    {% endif %}
    finishTyping(wpm, accuracy, mistakes, elapsed);
});


// Initialize and start countdown
{% if battle.mode == 'text' %}
initTextDisplay();
{% else %}
initCodeDisplay();
{% endif %}


// Disable input during countdown
typingInput.disabled = true;

// Start countdown
startCountdown();
</script>
{% endblock %}

