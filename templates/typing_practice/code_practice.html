{% extends 'base.html' %}
{% load static %}

{% block title %}Code Practice - Typing Trainer{% endblock %}

{% block extra_css %}
<style>
    .word { margin-right: 0.5rem; }
    .correct { color: #292929; }
    .incorrect { background-color: #fee2e2; color: #dc2626; }
    .current { background-color: rgba(41, 41, 41, 0.1); border-left: 3px solid #292929; padding-left: 2px; }
    .typed { color: #6b7280; }
    /* Stats - kompakt, 1 qator */
    .stats-compact {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 0.75rem 1rem;
        transition: opacity 0.3s ease;
    }
    .stats-compact .stat-item {
        text-align: center;
    }
    .stats-compact .stat-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    .stats-compact .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
    }
    .stats-compact .stat-divider {
        width: 1px;
        height: 2.5rem;
        background: #e5e7eb;
    }
    
    /* Progress bar - kattalashtirilgan */
    .progress-wrap { 
        background: #e5e7eb; 
        border-radius: 9999px; 
        height: 14px; 
        overflow: hidden; 
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .progress-bar { 
        height: 100%; 
        background: linear-gradient(90deg,#06b6d4,#7c3aed); 
        width: 0%; 
        transition: width 120ms linear; 
    }
    
    /* Code display - KATTA va MARKAZDA */
    #code-display { 
        font-size: 1rem; 
        padding: 1.5rem; 
        min-height: 250px;
        max-height: 400px;
        border: 3px solid rgba(41, 41, 41, 0.15);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        background: #f9fafb;
    }
    
    /* Typing input - KATTA va FOCUS */
    #typing-input { 
        font-size: 1rem; 
        line-height: 1.6;
        padding: 1.5rem; 
        min-height: 200px;
        border: 3px solid rgba(41, 41, 41, 0.2);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        resize: none;
    }
    #typing-input:focus {
        border-color: #292929;
        box-shadow: 0 0 0 4px rgba(41, 41, 41, 0.1), 0 10px 25px rgba(0, 0, 0, 0.1);
        outline: none;
    }
    
    /* Action buttons - kompakt */
    .action-buttons > * { 
        padding: 0.5rem 1rem; 
        font-size: 0.875rem; 
    }
    
    /* Practice container - markazda */
    .practice-container { 
        max-width: 900px; 
        margin: 0 auto; 
        padding: 1rem; 
    }
    
    /* Header - kompakt */
    .practice-header { 
        display: flex; 
        gap: 12px; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0.75rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    
    /* Instructions - minimal */
    .practice-instructions { 
        background: #f8fafc; 
        border: 1px solid #eef2ff; 
        padding: 8px 12px; 
        border-radius: 8px; 
        font-size: 0.875rem; 
        color: #374151; 
        margin-bottom: 1rem;
    }
    
    /* Focus mode - typing boshlanganda */
    .focus-mode .practice-header {
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }
    .focus-mode .stats-compact {
        opacity: 0.75;
        transition: opacity 0.3s ease;
    }
    
    @media (max-width: 768px) {
        .practice-container {
            padding: 0.5rem;
        }
        #code-display {
            font-size: 0.9rem;
            padding: 1rem;
            min-height: 200px;
            max-height: 300px;
        }
        #typing-input {
            font-size: 0.9rem;
            padding: 1rem;
            min-height: 150px;
        }
        .stats-compact {
            gap: 1rem;
            padding: 0.5rem;
        }
        .stats-compact .stat-value {
            font-size: 1rem;
        }
        .practice-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .action-buttons {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="practice-container">
    <!-- Minimal Header -->
    <div class="practice-header mb-4">
        <div class="flex items-center space-x-2">
            <div class="text-2xl">
                {% if code.language == 'python' %}üêç
                {% elif code.language == 'javascript' %}üü®
                {% elif code.language == 'cpp' %}‚öôÔ∏è
                {% elif code.language == 'java' %}‚òï
                {% else %}üíª{% endif %}
            </div>
            <div>
                <h2 class="text-lg font-semibold text-primary">{{ code.title }}</h2>
                <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
                    {{ code.language|upper }} ‚Ä¢ 
                    {% if code.difficulty == 'easy' %}üå± Oson
                    {% elif code.difficulty == 'medium' %}‚≠ê O'rta
                    {% else %}üî• Qiyin{% endif %}
                </span>
            </div>
        </div>
        <div class="flex items-center gap-2 action-buttons">
            <button id="reset-btn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Qayta boshlash (Ctrl+R)">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </button>
            <a href="?action=random&difficulty={{ code.difficulty }}" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Random kod">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </a>
            <a href="?action=next&code_id={{ code.id }}&difficulty={{ code.difficulty }}" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Keyingi kod">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Kompakt Stats (1 qator) -->
    <div class="stats-compact mb-4" id="stats-compact">
        <div class="stat-item">
            <p class="stat-label">WPM</p>
            <p class="stat-value text-primary" id="wpm">0</p>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <p class="stat-label">Aniqlik</p>
            <p class="stat-value text-green-600" id="accuracy">100%</p>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <p class="stat-label">Vaqt</p>
            <p class="stat-value text-blue-600" id="timer">0s</p>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <p class="stat-label">Xatolar</p>
            <p class="stat-value text-red-600" id="mistakes-count">0</p>
        </div>
    </div>

    <!-- Main Focus Area - KATTA va MARKAZDA -->
    <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8">
        <!-- Code Display - KATTA va MARKAZDA -->
        <div id="code-display" 
             role="region" 
             aria-label="Practice code" 
             class="bg-gray-50 text-primary rounded-xl mb-6 overflow-auto shadow-inner"
             style="font-family: 'Courier New', monospace; border: 3px solid rgba(41, 41, 41, 0.15);">
            <pre><code class="language-{{ code.language }}">{{ code.code_body }}</code></pre>
        </div>
        
        <!-- Progress Bar - kattalashtirilgan -->
        <div class="mb-6">
            <div class="progress-wrap">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
        </div>
        
        <!-- Typing Input - KATTA va FOCUS -->
        <textarea 
            id="typing-input" 
            class="w-full bg-white rounded-xl border-primary/30 focus:border-primary focus:ring-4 focus:ring-primary/20 font-mono text-primary placeholder-gray-400 transition-all duration-300 shadow-lg resize-none"
            style="border: 3px solid rgba(41, 41, 41, 0.2);"
            rows="8"
            placeholder="Bu yerga kod yozishni boshlang..."
            autofocus
            spellcheck="false"
            aria-label="Code typing input"
        ></textarea>
        
        <!-- Minimal Instructions -->
        <div class="mt-4 text-center text-xs text-gray-500">
            <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+R</kbd> qayta boshlash
        </div>
    </div>
    
    <!-- Results -->
    <div id="results" class="hidden mt-6 bg-white rounded-lg shadow-lg p-6 animate-fadeIn">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl font-bold text-primary flex items-center space-x-2">
                <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span>Natijalar</span>
            </h3>
            <a href="{% url 'typing_practice:index' %}" class="flex items-center space-x-2 text-primary hover:text-primary-dark font-semibold transition-colors duration-300 hover:underline">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span>Mashq qilishga qaytish</span>
            </a>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg hover-lift border-2 border-gray-200">
                <p class="text-sm font-semibold text-primary mb-1">Code WPM <span class="text-xs opacity-75">(Soatda so'zlar)</span></p>
                <p class="text-3xl font-bold text-primary" id="result-wpm">0</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg hover-lift border-2 border-gray-200">
                <p class="text-sm font-semibold text-primary mb-1">Aniqlik</p>
                <p class="text-3xl font-bold text-primary" id="result-accuracy">0%</p>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg hover-lift border-2 border-red-200">
                <p class="text-sm font-semibold text-primary mb-1">Xatolar</p>
                <p class="text-3xl font-bold text-primary" id="result-mistakes">0</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg hover-lift border-2 border-gray-200">
                <p class="text-sm font-semibold text-primary mb-1">Vaqt</p>
                <p class="text-3xl font-bold text-primary" id="result-time">0s</p>
            </div>
        </div>
        <div id="mistakes-list" class="mt-4"></div>
    </div>
</div>

<script>
// confetti lib
(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';s.async=true;document.head.appendChild(s);})();

function animateCounter(el, from, to, duration=800){
    const start = performance.now();
    function step(now){
        const t = Math.min(1,(now-start)/duration);
        const val = from + (to-from)*t;
        el.textContent = (Math.round(val));
        if(t<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}
const codeId = {{ code.id }};
const originalCode = `{{ code.code_body|escapejs }}`;
let startTime = null;
let timerInterval = null;
let isFinished = false;
let mistakesList = [];

const codeDisplay = document.getElementById('code-display');
const typingInput = document.getElementById('typing-input');
const resetBtn = document.getElementById('reset-btn');
const finishBtn = document.getElementById('finish-btn');
const resultsDiv = document.getElementById('results');

let lastTypedLength = 0;
let expectedNextChar = null;

// Initialize syntax highlighting
hljs.highlightAll();

function initCodeDisplay() {
    // Keep syntax highlighting but prepare for typing overlay
    const pre = codeDisplay.querySelector('pre');
    const code = pre.querySelector('code');
    const highlighted = hljs.highlight(code.textContent, { language: '{{ code.language }}' });
    code.innerHTML = highlighted.value;
    lastTypedLength = 0;
    expectedNextChar = originalCode[0] || null;
}

// Prevent copy-paste and show friendly toast
typingInput.addEventListener('paste', (e) => {
    e.preventDefault();
    if(window.TP_utils) TP_utils.showToast('Paste bloklandi. Adolatli o\'yin uchun to\'g\'ri yozing.', 'error', 3500);
    return false;
});

typingInput.addEventListener('copy', (e) => {
    e.preventDefault();
    if(window.TP_utils) TP_utils.showToast('Copy bloklandi.', 'info', 2000);
    return false;
});

typingInput.addEventListener('cut', (e) => {
    e.preventDefault();
    if(window.TP_utils) TP_utils.showToast('Cut bloklandi.', 'info', 2000);
    return false;
});

// Track each character input
typingInput.addEventListener('keydown', (e) => {
    // Allow backspace, delete, tab, escape, enter
    if (['Backspace', 'Delete', 'Tab', 'Escape', 'Enter'].includes(e.key)) {
        return;
    }
    
    // Allow Ctrl/Cmd combinations for shortcuts
    if (e.ctrlKey || e.metaKey) {
        return;
    }
    
    const currentValue = typingInput.value;
    const currentLength = currentValue.length;
    const originalLength = originalCode.length;
    
    // Prevent typing beyond the original code length only
    // Allow incorrect characters to be typed - they will be counted as mistakes
    if (currentLength >= originalLength) {
        e.preventDefault();
        return false;
    }
    
    expectedNextChar = originalCode[currentLength + 1] || null;
});

typingInput.addEventListener('input', (e) => {
    const currentValue = typingInput.value;
    const currentLength = currentValue.length;
    const previousLength = lastTypedLength;
    const originalLength = originalCode.length;
    
    // Detect if multiple characters were added at once (paste or drag-drop)
    if (currentLength - previousLength > 1) {
        // Reset to previous valid state
        typingInput.value = currentValue.substring(0, previousLength);
        return;
    }
    
    // Prevent typing beyond original code length
    // Allow incorrect characters to be typed - they will be counted as mistakes in updateDisplay()
    if (currentLength > originalLength) {
        typingInput.value = currentValue.substring(0, originalLength);
        lastTypedLength = originalLength;
    } else {
        lastTypedLength = typingInput.value.length;
    }
    
    startTyping();
    updateDisplay();
});

function updateDisplay() {
    const typed = typingInput.value;
    const originalLines = originalCode.split('\n');
    const typedLines = typed.split('\n');
    const original = originalCode;
    
    let html = '';
    let mistakes = 0;
    mistakesList = [];
    
    // Calculate character-level mistakes first (for accurate accuracy)
    let charMistakes = 0;
    const minLen = Math.min(typed.length, original.length);
    for (let i = 0; i < minLen; i++) {
        if (typed[i] !== original[i]) {
            charMistakes++;
        }
    }
    // Add extra or missing characters as mistakes
    charMistakes += Math.abs(typed.length - original.length);
    
    originalLines.forEach((line, lineIdx) => {
        const typedLine = typedLines[lineIdx] || '';
        let lineHtml = '<div class="code-line" data-line="' + lineIdx + '">';
        
        if (lineIdx < typedLines.length - 1) {
            // Completed line
            if (line === typedLine) {
                lineHtml += '<span class="correct typed">' + escapeHtml(line) + '</span>';
            } else {
                lineHtml += '<span class="incorrect typed">' + escapeHtml(line) + '</span>';
                mistakesList.push({ line: lineIdx + 1, original: line, typed: typedLine });
            }
        } else if (lineIdx === typedLines.length - 1) {
            // Current line - character by character
            for (let i = 0; i < line.length; i++) {
                const typedChar = typedLine[i] || '';
                const originalChar = line[i];
                
                if (i < typedLine.length) {
                    if (originalChar === typedChar) {
                        lineHtml += '<span class="correct typed">' + escapeHtml(originalChar) + '</span>';
                    } else {
                        lineHtml += '<span class="incorrect">' + escapeHtml(originalChar) + '</span>';
                    }
                } else if (i === typedLine.length) {
                    lineHtml += '<span class="current">' + escapeHtml(originalChar) + '</span>';
                } else {
                    lineHtml += '<span>' + escapeHtml(originalChar) + '</span>';
                }
            }
        } else {
            // Future line - show with syntax highlighting
            const highlighted = hljs.highlight(line, { language: '{{ code.language }}' });
            lineHtml += highlighted.value;
        }
        
        lineHtml += '</div>';
        html += lineHtml;
    });
    
    // Use character-level mistakes for accuracy calculation
    mistakes = charMistakes;
    
    codeDisplay.querySelector('pre code').innerHTML = html;
    
    // Re-highlight future lines
    hljs.highlightAll();
    
    // Calculate stats
    if (startTime) {
        const elapsed = (Date.now() - startTime) / 1000;
        const typedChars = typed.length;
        const correctChars = typedChars - mistakes;
        const wpm = (typedChars / 5 / elapsed) * 60;
        const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
        
            document.getElementById('wpm').textContent = Math.round(wpm);
            document.getElementById('accuracy').textContent = Math.round(accuracy) + '%';
            document.getElementById('timer').textContent = Math.round(elapsed) + 's';
            document.getElementById('mistakes-count').textContent = mistakes;

            // progress bar (by chars)
            const progressBar = document.getElementById('progress-bar');
            if(progressBar){
                if(window.TP_utils) window.TP_utils.updateProgressBar(progressBar, originalCode, typed);
                else {
                    const total = originalCode.length || 1;
                    const pct = Math.min(100, Math.round((typed.length/total)*100));
                    progressBar.style.width = pct + '%';
                }
            }
        
        // Check if finished
        if (typed.trim() === originalCode.trim()) {
            finishTyping(wpm, accuracy, mistakes);
        }
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function startTyping() {
    if (!startTime) {
        startTime = Date.now();
        timerInterval = setInterval(updateDisplay, 100);
        finishBtn.disabled = false;
        
        // Focus mode - minimize distractions
        document.querySelector('.practice-container')?.classList.add('focus-mode');
        
        // Focus on input
        typingInput.focus();
    }
}

function finishTyping(wpm, accuracy, mistakes) {
    if (isFinished) return;
    isFinished = true;
    
    clearInterval(timerInterval);
    typingInput.disabled = true;
    finishBtn.disabled = true;
    
    const duration = (Date.now() - startTime) / 1000;
    
    document.getElementById('result-wpm').textContent = Math.round(wpm);
    document.getElementById('result-accuracy').textContent = Math.round(accuracy) + '%';
    document.getElementById('result-mistakes').textContent = mistakes;
    document.getElementById('result-time').textContent = Math.round(duration) + 's';
    
    // Show mistakes list
    if (mistakesList.length > 0) {
        const mistakesDiv = document.getElementById('mistakes-list');
        mistakesDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3"><h4 class="font-bold mb-1 text-sm text-red-800">Xatolar:</h4><ul class="list-disc list-inside space-y-0.5 text-xs">';
        mistakesList.forEach(mistake => {
            mistakesDiv.innerHTML += `<li class="text-red-700">Qator ${mistake.line}: Kutilgan "${escapeHtml(mistake.original)}", yozilgan "${escapeHtml(mistake.typed)}"</li>`;
        });
        mistakesDiv.innerHTML += '</ul></div>';
    }
    
    resultsDiv.classList.remove('hidden');
    
    // show saving status in results area
    let saveStatus = document.getElementById('save-status');
    if (!saveStatus) {
        saveStatus = document.createElement('div');
        saveStatus.id = 'save-status';
        saveStatus.className = 'mt-3 text-sm text-gray-600';
        resultsDiv.appendChild(saveStatus);
    }
    saveStatus.textContent = 'Saqlanmoqda...';

    fetch('{% url "typing_practice:save_result" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            code_id: codeId,
            typed_text: typingInput.value,
            mode: 'full',
            time_limit: 0,
            wpm: wpm,
            accuracy: accuracy,
            mistakes: mistakes,
            mistakes_list: mistakesList,
            duration_seconds: Math.round(duration)
        })
    })
    .then(response => response.json().then(json => ({ status: response.status, body: json })))
    .then(({ status, body }) => {
        if (status >= 200 && status < 300 && body && body.success) {
            // Show motivational message if available
            if (body.message) {
                saveStatus.textContent = body.message;
                const msgType = body.type || 'success';
                if (msgType === 'success') {
                    saveStatus.className = 'mt-3 text-sm text-green-600 font-semibold';
                } else if (msgType === 'warning') {
                    saveStatus.className = 'mt-3 text-sm text-yellow-600 font-semibold';
                } else {
                    saveStatus.className = 'mt-3 text-sm text-blue-600 font-semibold';
                }
            } else {
                saveStatus.textContent = 'Natija saqlandi.';
                saveStatus.className = 'mt-3 text-sm text-green-600';
            }
            // animate and celebrate
            const wpmEl = document.getElementById('result-wpm');
            animateCounter(wpmEl, 0, Math.round(wpm));
            if(window.confetti && (accuracy >= 80 || typingInput.value.trim().length >= originalCode.trim().length)){
                confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
            }
        } else {
            const msg = (body && body.error) ? body.error : 'Xatolik yuz berdi';
            saveStatus.textContent = 'Xato: ' + msg;
            saveStatus.className = 'mt-3 text-sm text-red-600';
        }
    })
    .catch(err => {
        saveStatus.textContent = 'Internet aloqasi yo\'q: natija saqlanmadi.';
        saveStatus.className = 'mt-3 text-sm text-red-600';
        console.error('Save result error:', err);
    });
}

function reset() {
    typingInput.value = '';
    typingInput.disabled = false;
    startTime = null;
    isFinished = false;
    mistakesList = [];
    lastTypedLength = 0;
    expectedNextChar = originalCode[0] || null;
    clearInterval(timerInterval);
    timerInterval = null;
    finishBtn.disabled = true;
    resultsDiv.classList.add('hidden');
    
    // Remove focus mode
    document.querySelector('.practice-container')?.classList.remove('focus-mode');
    
    initCodeDisplay();
    document.getElementById('wpm').textContent = '0';
    document.getElementById('accuracy').textContent = '100%';
    document.getElementById('timer').textContent = '0s';
    document.getElementById('mistakes-count').textContent = '0';
    typingInput.focus();
}

// Input event is already handled above with paste prevention

if (finishBtn) {
    finishBtn.addEventListener('click', () => {
        if (!startTime) return;
        
        const typed = typingInput.value;
        const original = originalCode;
        
        // Calculate character-level mistakes (same as updateDisplay)
        let charMistakes = 0;
        const minLen = Math.min(typed.length, original.length);
        for (let i = 0; i < minLen; i++) {
            if (typed[i] !== original[i]) {
                charMistakes++;
            }
        }
        // Add extra or missing characters as mistakes
        charMistakes += Math.abs(typed.length - original.length);
        
        const elapsed = (Date.now() - startTime) / 1000;
        const typedChars = typed.length;
        const mistakes = charMistakes;
        const correctChars = typedChars - mistakes;
        const wpm = (typedChars / 5 / elapsed) * 60;
        const accuracy = typedChars > 0 ? ((correctChars / typedChars) * 100) : 100;
        finishTyping(wpm, accuracy, mistakes);
    });
}

resetBtn.addEventListener('click', reset);

initCodeDisplay();
// Remove the visible finish button ‚Äî sessions finish automatically when the text/code is complete
if (finishBtn && finishBtn.parentNode) {
    finishBtn.parentNode.removeChild(finishBtn);
}
// Keyboard shortcuts: Ctrl+R to reset, ? to toggle instructions
document.addEventListener('keydown', function(e){
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r'){
        e.preventDefault();
        reset();
    }
    if (e.key === '?'){
        const instr = document.getElementById('practice-instructions');
        if (instr) instr.style.display = (instr.style.display === 'none') ? 'block' : 'none';
    }
});
</script>
{% endblock %}

{% block extra_js %}
<script>
// Load achievements and render small summary for code practice
(async function(){
    try{
        const res = await fetch('{% url "typing_practice:achievements" %}');
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.success && json.achievements){
            const a = json.achievements;
            const panel = document.getElementById('achievements-panel');
            if(panel){
                panel.innerHTML = `So'nggi WPM: <strong>${Math.round(a.last_wpm)}</strong> ‚Ä¢ Eng yaxshi: <strong>${Math.round(a.best_wpm)}</strong>`;
            }
        }
    }catch(e){ /* ignore */ }
})();

// Flush offline queue when connection resumes
if(window.TP_utils){
    window.addEventListener('online', ()=>{
        const csrf = getCSRFToken();
        window.TP_utils.flushOfflineQueue('{% url "typing_practice:save_result" %}', csrf);
    });
}
</script>
<script src="{% static 'js/practice.js' %}"></script>
{% endblock %}
